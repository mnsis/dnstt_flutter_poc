name: build_ios

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'
          cache: true

      - name: Install gomobile
        shell: bash
        run: |
          set -eux
          GOPATH="$(go env GOPATH)"
          echo "GOPATH=${GOPATH}" >> "${GITHUB_ENV}"
          echo "${GOPATH}/bin" >> "${GITHUB_PATH}"
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          mkdir -p "${GOPATH}/src/golang.org/x"
          if [ ! -d "${GOPATH}/src/golang.org/x/mobile" ]; then
            git clone https://go.googlesource.com/mobile "${GOPATH}/src/golang.org/x/mobile"
          fi
          gomobile init

      - name: Build DNSTT.xcframework
        shell: bash
        env:
          GOPATH: ${{ env.GOPATH }}
          GO111MODULE: off
        run: |
          set -eux
          test -f go/dnsttwrap/go.mod
          mkdir -p packages/dnstt_mobile/ios/Frameworks
          pushd go/dnsttwrap
          go mod tidy
          gomobile bind -target=ios \
            -o ../../packages/dnstt_mobile/ios/Frameworks/DNSTT.xcframework \
            -prefix=DNSTT \
            .
          popd
          echo "=== headers ==="
          find packages/dnstt_mobile/ios/Frameworks/DNSTT.xcframework -name "*.h" -maxdepth 6 -print | head -n 30

      - name: Flutter pub get
        working-directory: app
        run: flutter pub get

      - name: Build iOS (no codesign)
        working-directory: app
        run: flutter build ios --no-codesign

      - name: Zip Runner.app
        working-directory: app
        run: ditto -c -k --sequesterRsrc --keepParent build/ios/iphoneos/Runner.app Runner.app.zip

      - name: Upload Runner.app
        uses: actions/upload-artifact@v4
        with:
          name: Runner.app
          path: app/Runner.app.zip
