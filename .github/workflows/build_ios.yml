name: build_ios

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.x'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'
          cache: true

      - name: Install gomobile (GOPATH with deps)
        shell: bash
        run: |
          set -eux
          export GOPATH="$HOME/go"
          export PATH="$GOPATH/bin:$PATH"
          export GO111MODULE=off

          mkdir -p "$GOPATH/src/golang.org/x"
          cd "$GOPATH/src/golang.org/x"

          [ -d mobile ] || git clone https://go.googlesource.com/mobile
          [ -d mod ]    || git clone https://go.googlesource.com/mod
          [ -d sync ]   || git clone https://go.googlesource.com/sync
          [ -d tools ]  || git clone https://go.googlesource.com/tools
          [ -d sys ]    || git clone https://go.googlesource.com/sys

          cd mobile
          go install ./cmd/gomobile ./cmd/gobind
          gomobile init

      - name: Build DNSTT.xcframework
        shell: bash
        run: |
          set -eux
          export GOPATH="$HOME/go"
          export PATH="$GOPATH/bin:$PATH"
          export GO111MODULE=off

          mkdir -p packages/dnstt_mobile/ios/Frameworks

          mkdir -p "$GOPATH/src/example.com"
          rm -rf "$GOPATH/src/example.com/dnsttwrap"
          ln -s "$GITHUB_WORKSPACE/go/dnsttwrap" "$GOPATH/src/example.com/dnsttwrap"

          gomobile bind -target=ios \
            -o "$GITHUB_WORKSPACE/packages/dnstt_mobile/ios/Frameworks/DNSTT.xcframework" \
            -prefix=DNSTT \
            example.com/dnsttwrap

      - name: (debug) show generated symbols
        shell: bash
        run: |
          set -eux
          grep -R "StartTunnel\|StopTunnel\|IsRunning\|LastError" -n \
            packages/dnstt_mobile/ios/Frameworks/DNSTT.xcframework || true

      - name: Flutter pub get
        working-directory: app
        run: flutter pub get

      - name: Build iOS (no codesign)
        working-directory: app
        run: flutter build ios --no-codesign

      - name: Zip Runner.app
        working-directory: app
        run: ditto -c -k --sequesterRsrc --keepParent build/ios/iphoneos/Runner.app Runner.app.zip

      - name: Upload Runner.app
        uses: actions/upload-artifact@v4
        with:
          name: Runner.app
          path: app/Runner.app.zip
